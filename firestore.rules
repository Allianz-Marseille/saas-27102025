rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMINISTRATEUR';
    }
    
    // Helper function to check if user is CDC
    function isCDC() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'CDC_COMMERCIAL';
    }
    
    // Helper function to check if user is Commercial Santé Individuel
    function isCommercialSante() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'COMMERCIAL_SANTE_INDIVIDUEL';
    }
    
    // Helper function to check if user is Commercial Santé Collective
    function isCommercialSanteCollective() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'COMMERCIAL_SANTE_COLLECTIVE';
    }
    
    // Helper function to check if user is Gestionnaire Sinistre
    function isGestionnaireSinistre() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'GESTIONNAIRE_SINISTRE';
    }
    
    // Users collection
    // Lecture restreinte : uniquement le propriétaire ou l'admin
    // Protection des données personnelles des utilisateurs
    match /users/{userId} {
      allow read: if isAdmin() || (isAuthenticated() && userId == request.auth.uid);
      allow create: if false; // Only server-side
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Acts collection
    // Lecture restreinte : uniquement le propriétaire ou l'admin
    // Cette restriction améliore la confidentialité des données commerciales
    match /acts/{actId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Création : les commerciaux CDC peuvent créer tous types d'actes (AN, M+3, PRETERME_AUTO, PRETERME_IRD)
      // Validation que l'utilisateur est bien le propriétaire de l'acte et que les champs obligatoires sont présents
      allow create: if isCDC() && request.resource.data.userId == request.auth.uid;
      
      allow update: if isAdmin() || (isCDC() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin() || (isCDC() && resource.data.userId == request.auth.uid);
    }
    
    // Companies collection
    match /companies/{companyId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Commission rules collection
    // Règles de calcul des commissions - lecture pour tous authentifiés (nécessaire pour les calculs)
    // Écriture réservée aux admins uniquement
    match /commissionRules/{ruleId} {
      allow read: if isAuthenticated(); // Nécessaire pour les calculs côté client
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Health acts collection (Santé Individuelle)
    // Lecture restreinte : uniquement le propriétaire ou l'admin
    // Protection de la confidentialité des données commerciales
    match /health_acts/{actId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      // Création : les commerciaux Santé Individuelle peuvent créer leurs propres actes
      allow create: if isCommercialSante() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isCommercialSante() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin() || (isCommercialSante() && resource.data.userId == request.auth.uid);
    }
    
    // Health collective acts collection (Santé Collective)
    // Lecture restreinte : uniquement le propriétaire ou l'admin
    // Protection de la confidentialité des données commerciales
    match /health_collective_acts/{actId} {
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      allow create: if isCommercialSanteCollective() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isCommercialSanteCollective() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin() || (isCommercialSanteCollective() && resource.data.userId == request.auth.uid);
    }
    
    // Logs collection
    match /logs/{logId} {
      allow read: if isAdmin(); // Only admins can read logs
      allow create: if isAuthenticated(); // Any authenticated user can create logs
      allow update: if false; // Logs are immutable
      allow delete: if false; // Logs cannot be deleted to preserve audit trail
    }
    
    // Leaderboard collection
    // Collection agrégée pour les classements - lecture publique, écriture admin uniquement
    match /leaderboard/{entryId} {
      allow read: if isAuthenticated(); // Tous les utilisateurs authentifiés peuvent lire
      allow create: if isAdmin(); // Seuls les admins peuvent créer (via script)
      allow update: if isAdmin(); // Seuls les admins peuvent mettre à jour (via script)
      allow delete: if isAdmin(); // Seuls les admins peuvent supprimer
    }
    
    // Agency commissions collection
    // Données sensibles de l'agence - accès réservé aux administrateurs uniquement
    match /agency_commissions/{commissionId} {
      allow read: if isAdmin(); // Seuls les admins peuvent lire
      allow create: if isAdmin(); // Seuls les admins peuvent créer
      allow update: if isAdmin(); // Seuls les admins peuvent mettre à jour
      allow delete: if isAdmin(); // Seuls les admins peuvent supprimer
    }
    
    // Salary history collection
    // Historique des rémunérations - accès réservé aux administrateurs uniquement
    // Les données sont sensibles et confidentielles
    match /salary_history/{historyId} {
      allow read: if isAdmin(); // Seuls les admins peuvent lire
      allow create: if isAdmin(); // Seuls les admins peuvent créer
      allow update: if false; // L'historique est immuable une fois créé
      allow delete: if isAdmin(); // Seuls les admins peuvent supprimer (nettoyage > 3 ans)
    }
    
    // Salary drafts collection
    // Brouillons d'augmentations - brouillon partagé entre tous les admins
    // Permet de sauvegarder des simulations avant validation définitive
    match /salary_drafts/{draftId} {
      // Brouillon partagé : tous les admins peuvent lire/modifier
      allow read, write: if isAdmin() && draftId == "shared";
      
      // Anciens brouillons individuels : migration progressive (lecture seule pour compatibilité)
      allow read: if isAdmin() && request.auth.uid == draftId;
      allow write: if false; // Plus de modification des brouillons individuels
    }
    
    // Assistant conversations collection
    // Conversations sauvegardées - lecture/écriture pour le propriétaire
    // Note: La vérification du partage se fait côté serveur dans l'API car Firestore Rules
    // ne permet pas facilement de vérifier si un userId est dans un tableau d'objets
    match /assistant_conversations/{conversationId} {
      // Création : l'utilisateur doit être le propriétaire (request.resource pour nouveau doc)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Lecture, mise à jour, suppression : le propriétaire peut tout faire (resource pour doc existant)
      allow read, update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Les admins peuvent tout faire (pour support)
      allow read, write: if isAdmin();
      
      // Note: Les conversations partagées sont gérées via l'API qui vérifie les permissions côté serveur
    }
    
    // Sinistres collection
    // Gestion des sinistres - accès pour Admin, Gestionnaire Sinistre et CDC Commercial
    match /sinistres/{sinistreId} {
      // Lecture : Admin, Gestionnaire Sinistre ou CDC Commercial
      allow read: if isAdmin() || isGestionnaireSinistre() || isCDC();
      
      // Création : Admin uniquement (via API)
      allow create: if isAdmin();
      
      // Modification : Admin, Gestionnaire Sinistre ou CDC Commercial (pour leurs sinistres affectés)
      // Un CDC peut modifier uniquement les sinistres qui lui sont affectés
      allow update: if isAdmin() || 
                      isGestionnaireSinistre() || 
                      (isCDC() && (resource.data.assignedTo == request.auth.uid || !resource.data.assignedTo));
      
      // Suppression : Admin uniquement
      allow delete: if isAdmin();
      
      // Notes sous-collection
      match /notes/{noteId} {
        // Lecture/écriture pour tous les rôles autorisés
        allow read: if isAdmin() || isGestionnaireSinistre() || isCDC();
        allow create: if isAdmin() || isGestionnaireSinistre() || isCDC();
        // Modification : propriétaire de la note ou admin
        allow update: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
        // Suppression : propriétaire de la note ou admin
        allow delete: if isAdmin() || (isAuthenticated() && resource.data.authorId == request.auth.uid);
      }
      
      // Historique sous-collection
      match /history/{historyId} {
        // Lecture pour tous les rôles autorisés, écriture admin uniquement (via API)
        allow read: if isAdmin() || isGestionnaireSinistre() || isCDC();
        allow create: if isAdmin(); // L'historique est créé automatiquement par l'API
        allow update, delete: if false; // L'historique est immuable
      }
    }
    
    // Sinistres metadata collection
    // Métadonnées des imports - lecture pour tous les rôles autorisés, écriture admin uniquement
    match /sinistres_metadata/{docId} {
      allow read: if isAdmin() || isGestionnaireSinistre() || isCDC();
      allow create, update, delete: if isAdmin();
    }
    
    // Admin messages collection
    // Messages envoyés par les administrateurs aux commerciaux
    // Lecture : ADMIN uniquement (les récepteurs accèdent via message_recipients)
    match /admin_messages/{messageId} {
      // Lecture : Seuls les admins peuvent lire directement les messages
      allow read: if isAdmin();
      
      // Création : Seuls les admins peuvent créer, avec vérification createdBy == auth.uid
      allow create: if isAdmin() && request.resource.data.createdBy == request.auth.uid;
      
      // Modification : Seuls les admins peuvent modifier
      allow update: if isAdmin();
      
      // Suppression : Seuls les admins peuvent supprimer
      allow delete: if isAdmin();
    }
    
    // Message recipients collection
    // Destinataires des messages - lien entre messages et utilisateurs
    match /message_recipients/{recipientId} {
      // Lecture : Admin voit tout, destinataire voit uniquement ses propres messages
      allow read: if isAdmin() || (isAuthenticated() && resource.data.userId == request.auth.uid);
      
      // Création : Seuls les admins peuvent créer (lors de la création d'un message)
      allow create: if isAdmin();
      
      // Modification : Admin peut tout modifier, destinataire peut uniquement marquer comme lu
      // Le destinataire peut uniquement modifier les champs read, readAt, notified, notifiedAt, readTime, readProgress
      allow update: if isAdmin() || 
                      (isAuthenticated() && 
                       resource.data.userId == request.auth.uid &&
                       // Vérifier que les champs non modifiables restent identiques
                       request.resource.data.messageId == resource.data.messageId &&
                       request.resource.data.userId == resource.data.userId &&
                       request.resource.data.id == resource.data.id &&
                       request.resource.data.createdAt == resource.data.createdAt);
      
      // Suppression : Seuls les admins peuvent supprimer
      allow delete: if isAdmin();
    }
  }
}

